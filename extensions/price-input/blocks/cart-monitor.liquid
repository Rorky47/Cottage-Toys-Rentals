<script>
  (function() {
    // This script runs on cart page to detect when rental items are removed
    // and unreserve the associated bookings
    
    var API_UNRESERVE = '/unreserve';
    var APP_PROXY_PREFIX = '/apps/nds-rentalrates-app';
    var currentCart = null;
    
    function appProxyUrl(path) {
      return APP_PROXY_PREFIX + path;
    }
    
    function loadCurrentCart() {
      return fetch('/cart.js', { credentials: 'same-origin' })
        .then(function(res) { 
          console.log('[rental-cart] Loaded cart, status:', res.status);
          return res.json(); 
        })
        .then(function(cart) {
          console.log('[rental-cart] Cart items count:', cart.items ? cart.items.length : 0);
          currentCart = cart;
          return cart;
        })
        .catch(function(err) {
          console.error('[rental-cart] Failed to load cart:', err);
          return null;
        });
    }
    
    function checkForRemovals(cartBefore, newCart) {
      console.log('[rental-cart] Checking for removals');
      console.log('[rental-cart] Cart before:', cartBefore ? cartBefore.items.length + ' items' : 'null');
      console.log('[rental-cart] Cart after:', newCart ? newCart.items.length + ' items' : 'null');
      
      if (!cartBefore || !newCart) return;
      
      // Build map of remaining bookingRefs
      var remainingBookingRefs = {};
      if (newCart.items) {
        newCart.items.forEach(function(item) {
          if (item.properties && item.properties._booking_ref) {
            remainingBookingRefs[item.properties._booking_ref] = true;
          }
        });
      }
      console.log('[rental-cart] Remaining booking refs:', Object.keys(remainingBookingRefs).length);
      
      // Check if any bookings were removed
      if (cartBefore.items) {
        cartBefore.items.forEach(function(item) {
          if (item.properties && item.properties._booking_ref) {
            var bookingRef = item.properties._booking_ref;
            console.log('[rental-cart] Checking booking ref:', bookingRef);
            if (!remainingBookingRefs[bookingRef]) {
              console.log('[rental-cart] ✓ Item removed, unreserving:', bookingRef);
              unreserveBooking(bookingRef);
            } else {
              console.log('[rental-cart] Item still in cart:', bookingRef);
            }
          }
        });
      }
    }
    
    function unreserveBooking(bookingRef) {
      console.log('[rental-cart] Unreserving booking:', bookingRef);
      var url = appProxyUrl(API_UNRESERVE);
      console.log('[rental-cart] POST to:', url);
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ booking_ref: bookingRef })
      })
        .then(function(response) {
          console.log('[rental-cart] Unreserve response status:', response.status);
          return response.json();
        })
        .then(function(data) {
          console.log('[rental-cart] Unreserve response:', data);
          if (data.ok) {
            console.log('[rental-cart] ✓ Successfully unreserved:', bookingRef);
          } else {
            console.warn('[rental-cart] ✗ Unreserve failed:', data.error);
          }
        })
        .catch(function(e) {
          console.error('[rental-cart] ✗ Network error unreserving:', e);
        });
    }
    
    // Load initial cart state
    loadCurrentCart();
    
    // Intercept XMLHttpRequest (many themes use this instead of fetch)
    var originalXHROpen = XMLHttpRequest.prototype.open;
    var originalXHRSend = XMLHttpRequest.prototype.send;
    
    XMLHttpRequest.prototype.open = function(method, url) {
      this._url = url;
      this._method = method;
      return originalXHROpen.apply(this, arguments);
    };
    
    XMLHttpRequest.prototype.send = function() {
      var xhr = this;
      var url = String(this._url || '');
      
      if (url.includes('/cart/change') || url.includes('/cart/update') || url.includes('/cart/clear')) {
        console.log('[rental-cart] Detected XHR cart modification:', url);
        var cartBefore = currentCart;
        
        xhr.addEventListener('load', function() {
          console.log('[rental-cart] XHR completed, reloading cart...');
          setTimeout(function() {
            loadCurrentCart().then(function(newCart) {
              checkForRemovals(cartBefore, newCart);
            });
          }, 200);
        });
      }
      
      return originalXHRSend.apply(this, arguments);
    };
    
    // Also intercept fetch API
    var originalFetch = window.fetch;
    window.fetch = function(url, options) {
      var promise = originalFetch.apply(this, arguments);
      
      // Detect cart modification API calls
      if (typeof url === 'string' && 
          (url.includes('/cart/change.js') || 
           url.includes('/cart/update.js') || 
           url.includes('/cart/clear.js'))) {
        
        console.log('[rental-cart] Detected fetch cart modification:', url);
        var cartBefore = currentCart;
        
        // After the change completes, check what was removed
        promise.then(function(response) {
          console.log('[rental-cart] Fetch completed, reloading cart...');
          setTimeout(function() {
            loadCurrentCart().then(function(newCart) {
              checkForRemovals(cartBefore, newCart);
            });
          }, 200);
        }).catch(function() {});
      }
      
      return promise;
    };
    
    // Listen for cart:updated events from themes
    if (typeof document !== 'undefined') {
      document.addEventListener('cart:updated', function() {
        setTimeout(function() {
          var cartBefore = currentCart;
          loadCurrentCart().then(function(newCart) {
            checkForRemovals(cartBefore, newCart);
          });
        }, 100);
      });
    }
    
    console.log('[rental-cart] Cart monitor initialized (event-driven, no polling)');
  })();
  
  // Add rental dates to product titles in cart (matches checkout format)
  (function() {
    function formatCartTitles() {
      fetch('/cart.js', { credentials: 'same-origin' })
        .then(function(res) { return res.json(); })
        .then(function(cart) {
          if (!cart.items) return;
          
          cart.items.forEach(function(item, index) {
            var props = item.properties || {};
            
            // Check if this is a rental item
            if (props._rental_start && props._rental_end) {
              var titleSuffix = ' (Rental: ' + props._rental_start + ' to ' + props._rental_end + ')';
              
              // Find title element (varies by theme)
              var selectors = [
                '.cart-item:nth-of-type(' + (index + 1) + ') .cart-item__name',
                '.cart-item:nth-of-type(' + (index + 1) + ') a',
                '.cart__item:nth-of-type(' + (index + 1) + ') .cart__item-name',
                'tr:nth-of-type(' + (index + 1) + ') .cart-item__title'
              ];
              
              var titleEl = null;
              for (var i = 0; i < selectors.length; i++) {
                titleEl = document.querySelector(selectors[i]);
                if (titleEl && !titleEl.textContent.includes('Rental:')) break;
                titleEl = null;
              }
              
              if (titleEl && !titleEl.textContent.includes('Rental:')) {
                titleEl.textContent = titleEl.textContent + titleSuffix;
              }
            }
          });
        })
        .catch(function() {});
    }
    
    // Run on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', formatCartTitles);
    } else {
      setTimeout(formatCartTitles, 100);
    }
    
    // Re-run on cart updates
    document.addEventListener('cart:updated', function() {
      setTimeout(formatCartTitles, 200);
    });
  })();
</script>

{% schema %}
{
  "name": "Rental Cart Monitor",
  "target": "section",
  "enabled_on": { "templates": ["cart"] },
  "settings": []
}
{% endschema %}
