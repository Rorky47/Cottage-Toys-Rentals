// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "sqlite"
  url      = "file:dev.sqlite"
}

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

// Minimal reference to Shopify products the app tracks/manipulates.
// Shopify remains the source of truth for price/inventory/etc.
model ProductReference {
  id               String   @id @default(cuid())
  shop             String
  shopifyProductId String   @map("shopify_product_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@unique([shop, shopifyProductId])
  @@map("product_references")
}

enum BookingStatus {
  RESERVED
  CONFIRMED
  CANCELLED
  RETURNED
}

enum PricingAlgorithm {
  FLAT
  TIERED
}

enum FulfillmentMethod {
  UNKNOWN
  SHIP
  PICKUP
}

model RentalItem {
  id                   String   @id @default(cuid())
  shop                 String
  shopifyProductId     String   @map("shopify_product_id")
  name                 String?
  imageUrl             String?  @map("image_url")
  currencyCode         String   @default("USD") @map("currency_code")
  basePricePerDayCents Int      @map("base_price_per_day_cents")
  pricingAlgorithm     PricingAlgorithm @default(FLAT) @map("pricing_algorithm")
  quantity             Int      @default(1)
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  rateTiers RateTier[]
  bookings  Booking[]

  @@unique([shop, shopifyProductId])
  @@map("rental_items")
}

model RateTier {
  id              String   @id @default(cuid())
  rentalItemId    String   @map("rental_item_id")
  minDays         Int      @map("min_days")
  pricePerDayCents Int     @map("price_per_day_cents")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  rentalItem RentalItem @relation(fields: [rentalItemId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([rentalItemId, minDays])
  @@index([rentalItemId])
  @@map("rate_tiers")
}

model Booking {
  id           String        @id @default(cuid())
  rentalItemId String        @map("rental_item_id")
  orderId      String?       @map("order_id")
  startDate    DateTime      @map("start_date")
  endDate      DateTime      @map("end_date")
  units        Int           @default(1)
  status       BookingStatus @default(CONFIRMED)
  fulfillmentMethod FulfillmentMethod @default(UNKNOWN) @map("fulfillment_method")
  expiresAt    DateTime?     @map("expires_at")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  rentalItem RentalItem @relation(fields: [rentalItemId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([rentalItemId])
  @@index([startDate, endDate])
  @@index([rentalItemId, startDate])
  @@index([status, orderId])
  @@map("bookings")
}
